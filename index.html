<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MIL Terms Explorer (Tailwind + AJAX)</title>
  <!-- Tailwind CDN：免安裝即可使用 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 純裝飾：滑動切換過場 */
    .tab { display: none; }
    .tab.active { display: block; animation: fade .2s ease; }
    @keyframes fade { from{opacity:0} to{opacity:1} }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="container mx-auto max-w-6xl p-4 md:p-8 space-y-6">
    <!-- Header -->
    <header class="rounded-2xl p-6 md:p-8 text-white shadow bg-gradient-to-r from-indigo-500 to-violet-600">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold">🧠 MIL Terms Explorer</h1>
          <p class="text-white/90"><code>/terms</code>、<code>/terms/&lt;t1&gt;</code>、<code>/query/&lt;q_string&gt;/studies</code></p>
        </div>
        <div class="bg-white/15 rounded-xl px-3 py-2 text-sm flex items-center gap-2">
          <span>API Base URL：</span>
          <input id="apiBase" class="bg-white/20 rounded-lg px-2 py-1 w-[320px] focus:outline-none" value="https://mil.psy.ntu.edu.tw:5000" />
        </div>
      </div>
      <div class="mt-4 flex flex-wrap gap-2">
        <button data-tab="terms" class="tab-btn rounded-xl bg-white/20 px-3 py-1 text-sm font-semibold hover:bg-white/30">/terms</button>
        <button data-tab="assoc" class="tab-btn rounded-xl bg-white/20 px-3 py-1 text-sm font-semibold hover:bg-white/30">/terms/&lt;t1&gt;</button>
        <button data-tab="query" class="tab-btn rounded-xl bg-white/20 px-3 py-1 text-sm font-semibold hover:bg-white/30">/query/&lt;q_string&gt;/studies</button>
        <span id="globalStatus" class="ml-auto text-sm text-white/80">狀態：就緒</span>
      </div>
    </header>

    <!-- /terms 所有詞彙 -->
    <section id="tab-terms" class="tab active">
      <div class="bg-white rounded-xl shadow p-5 space-y-3">
        <h2 class="text-xl font-semibold">/terms：所有可用詞彙</h2>
        <div class="flex justify-between items-center">
          <p class="text-sm text-slate-600">點擊任一詞彙可複製到剪貼簿</p>
          <button id="btn-terms" class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-4 py-2 font-semibold text-white shadow hover:bg-indigo-500 active:bg-indigo-700 transition disabled:opacity-60">🔄 重新載入</button>
        </div>
        <p id="status-terms" class="text-sm text-slate-500">狀態：尚未查詢</p>
        <div id="rows-terms" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 mt-4">
          <!-- Terms 將以卡片形式顯示在這裡 -->
        </div>
      </div>
    </section>

    <!-- /terms/<t1> 關聯詞彙 -->
    <section id="tab-assoc" class="tab">
      <div class="bg-white rounded-xl shadow p-5 space-y-3">
        <h2 class="text-xl font-semibold">/terms/&lt;t1&gt;：查詢與 t1 關聯的詞彙</h2>
        <form id="form-assoc" class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
          <div class="sm:col-span-2">
            <label class="block text-sm text-slate-600 mb-1">Term t1（必填）</label>
            <input id="assocT1" required placeholder="例如：posterior_cingulate" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <button id="btn-assoc" class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-4 py-2 font-semibold text-white shadow hover:bg-indigo-500 active:bg-indigo-700 transition disabled:opacity-60">查詢</button>
        </form>
        <p class="text-slate-600">查詢詞彙：<span id="show-assocT1" class="font-semibold">（未填）</span></p>
        <p id="status-assoc" class="text-sm text-slate-500">狀態：尚未查詢</p>
        <div id="rows-assoc" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mt-4">
          <!-- 關聯詞彙將以卡片形式顯示在這裡 -->
        </div>
      </div>
    </section>

    <!-- /query/<q_string>/studies 邏輯搜尋 -->
    <section id="tab-query" class="tab">
      <div class="bg-white rounded-xl shadow p-5 space-y-3">
        <h2 class="text-xl font-semibold">/query/&lt;q_string&gt;/studies：邏輯搜尋</h2>
        <form id="form-query" class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
          <div class="sm:col-span-2">
            <label class="block text-sm text-slate-600 mb-1">q_string（必填）</label>
            <input id="queryStr" required placeholder="例如：posterior_cingulate AND NOT ventromedial_prefrontal" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <button id="btn-query" class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-4 py-2 font-semibold text-white shadow hover:bg-indigo-500 active:bg-indigo-700 transition disabled:opacity-60">查詢</button>
        </form>
        <p class="text-slate-600 text-sm">查詢語句支援 AND/OR/NOT 邏輯運算子，將自動進行 URL encode。</p>
        <p id="status-query" class="text-sm text-slate-500">狀態：尚未查詢</p>
        <div id="rows-query" class="space-y-4 mt-4">
          <!-- 研究結果將以卡片形式顯示在這裡 -->
        </div>
      </div>
    </section>
  </main>

  <script>
    // ======== 小工具 ========
    const $ = (id) => document.getElementById(id);

    function setGlobalStatus(msg) { $("globalStatus").textContent = "狀態：" + msg; }
    function setStatus(id, msg, isErr=false){
      const el = $(id);
      el.textContent = (isErr? "錯誤：" : "狀態：") + msg;
      el.className = 'text-sm ' + (isErr? 'text-red-600' : 'text-slate-500');
    }

    function api(url) {
      // 接受 JSON 或 HTML 兩種情況
      return fetch(url, { headers: { 'Accept': 'application/json,text/html;q=0.9,*/*;q=0.8' } });
    }

    // 嘗試從 JSON 結構抽出陣列
    function guessArray(data){
      if (Array.isArray(data)) return data;
      if (data == null) return [];
      // 優先檢查 data.terms（這是 /terms 的 API 格式）
      if (Array.isArray(data.terms)) return data.terms;
      // 檢查 data.related（這是 /terms/<t1> 的 API 格式）
      if (Array.isArray(data.related)) return data.related;
      // 檢查 data.results（這是 /query/<q_string>/studies 的 API 格式）
      if (Array.isArray(data.results)) return data.results;
      if (Array.isArray(data.items)) return data.items;
      if (Array.isArray(data.data)) return data.data;
      // 若是物件 map：{ term: count, ... }
      if (typeof data === 'object') {
        const entries = Object.entries(data);
        if (entries.every(([k,v]) => typeof v === 'number' || typeof v === 'string' || typeof v === 'object')) {
          return entries.map(([k,v]) => ({ term: k, value: v }));
        }
      }
      return [];
    }

    // 將任何值安全轉成字串
    const S = (x) => (x == null ? '' : String(x));

    // 複製到剪貼簿的功能
    function copyToClipboard(text, element) {
      navigator.clipboard.writeText(text).then(() => {
        const originalHTML = element.innerHTML;
        element.innerHTML = '<div class="text-white font-semibold text-center">✓ 已複製！</div>';
        setTimeout(() => {
          element.innerHTML = originalHTML;
        }, 1000);
      }).catch(err => {
        console.error('複製失敗：', err);
      });
    }

    // 解析 HTML 表格為列資料（通用備援）
    function parseHtmlTable(html){
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const trs = Array.from(doc.querySelectorAll('tbody tr'));
      return trs.map(tr => Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim()));
    }

    // 渲染通用表格列
    function renderRows(tbodyId, rowsHtml){ $(tbodyId).innerHTML = rowsHtml.join(''); }

    // ======== /terms ========
    function buildTermsUrl(){
      const base = $("apiBase").value.replace(/\/$/, '');
      return base + '/terms';
    }

    async function onTerms(e){
      e?.preventDefault();
      const url = buildTermsUrl();
      setStatus('status-terms', '請求中… ' + url);
      setGlobalStatus('/terms 請求中');
      $('btn-terms').disabled = true;
      try {
        const resp = await api(url);
        const ct = resp.headers.get('content-type') || '';
        if (!resp.ok) { setStatus('status-terms', `HTTP ${resp.status} ${resp.statusText}`, true); return; }
        if (ct.includes('application/json')){
          const data = await resp.json();
          const arr = guessArray(data);
          const cards = arr.map((x,i)=>{
            // x 現在是字串（因為 data.terms 是字串陣列）
            const term = (typeof x === 'string') ? x : (x.term || x.name || x[0] || '');
            const weight = (typeof x === 'object') ? (x.weight || x.score || x.count || x.value || '') : '';
            return `<div class="group relative bg-gradient-to-br from-indigo-500 to-violet-600 rounded-xl p-4 shadow-md hover:shadow-xl transition-all duration-300 hover:scale-105 cursor-pointer" 
                    onclick="copyToClipboard('${S(term).replace(/'/g, "\\'")}', this)" 
                    title="點擊複製：${S(term)}">
              <div class="text-white font-semibold text-center break-words">${S(term)}</div>
              ${weight ? `<div class="text-white/70 text-xs text-center mt-2">${S(weight)}</div>` : ''}
              <div class="absolute inset-0 bg-white/0 group-hover:bg-white/10 rounded-xl transition-all duration-300"></div>
            </div>`;
          });
          $('rows-terms').innerHTML = cards.join('');
          setStatus('status-terms', `完成（共 ${arr.length} 個詞彙）`);
        } else {
          const text = await resp.text();
          const table = parseHtmlTable(text); // [[#, term, weight], ...]
          const cards = table.map((cells, i) => {
            const term = cells[1] || cells[0] || '';
            const weight = cells[2] || '';
            return `<div class="group relative bg-gradient-to-br from-indigo-500 to-violet-600 rounded-xl p-4 shadow-md hover:shadow-xl transition-all duration-300 hover:scale-105 cursor-pointer" 
                    onclick="copyToClipboard('${S(term).replace(/'/g, "\\'")}', this)" 
                    title="點擊複製：${S(term)}">
              <div class="text-white font-semibold text-center break-words">${S(term)}</div>
              ${weight ? `<div class="text-white/70 text-xs text-center mt-2">${S(weight)}</div>` : ''}
              <div class="absolute inset-0 bg-white/0 group-hover:bg-white/10 rounded-xl transition-all duration-300"></div>
            </div>`;
          });
          $('rows-terms').innerHTML = cards.join('');
          setStatus('status-terms', `完成（HTML 解析，共 ${table.length} 個詞彙）`);
        }
      } catch (err) {
        setStatus('status-terms', (err?.message || err) + '（可能是 CORS、網路或伺服器問題）', true);
      } finally {
        $('btn-terms').disabled = false;
        setGlobalStatus('就緒');
      }
    }

    // ======== /terms/<t1> ========
    function buildAssocUrl(){
      const base = $("apiBase").value.replace(/\/$/, '');
      const t1 = $("assocT1").value.trim();
      return base + '/terms/' + encodeURIComponent(t1);
    }

    async function onAssoc(e){
      e?.preventDefault();
      const t1 = $('assocT1').value.trim();
      $("show-assocT1").textContent = t1 || '（未填）';
      if (!t1) { setStatus('status-assoc', '請輸入 t1', true); return; }
      const url = buildAssocUrl();
      setStatus('status-assoc', '請求中… ' + url);
      setGlobalStatus('/terms/<t1> 請求中');
      $('btn-assoc').disabled = true;
      try{
        const resp = await api(url);
        const ct = resp.headers.get('content-type') || '';
        if (!resp.ok) { setStatus('status-assoc', `HTTP ${resp.status} ${resp.statusText}`, true); return; }
        if (ct.includes('application/json')){
          const data = await resp.json();
          const arr = guessArray(data);
          const cards = arr.map((x,i)=>{
            // x 是物件：{ term: "emotional", co_count: 726, jaccard: 0.283... }
            const term = x.term || x.name || x.related || '';
            const jaccard = x.jaccard ? x.jaccard.toFixed(4) : '';
            const coCount = x.co_count || x.count || '';
            return `<div class="group relative bg-gradient-to-br from-indigo-500 to-violet-600 rounded-xl p-4 shadow-md hover:shadow-xl transition-all duration-300 hover:scale-105 cursor-pointer" 
                    onclick="copyToClipboard('${S(term).replace(/'/g, "\\'")}', this)" 
                    title="點擊複製：${S(term)}">
              <div class="text-white font-semibold text-center text-lg mb-2 break-words">${S(term)}</div>
              <div class="text-white/90 text-xs space-y-1">
                ${jaccard ? `<div class="flex justify-between"><span>Jaccard:</span><span class="font-mono">${jaccard}</span></div>` : ''}
                ${coCount ? `<div class="flex justify-between"><span>共現次數:</span><span class="font-mono">${coCount}</span></div>` : ''}
              </div>
              <div class="absolute inset-0 bg-white/0 group-hover:bg-white/10 rounded-xl transition-all duration-300"></div>
            </div>`;
          });
          $('rows-assoc').innerHTML = cards.join('');
          setStatus('status-assoc', `完成（共 ${arr.length} 個關聯詞彙）`);
        } else {
          const text = await resp.text();
          const table = parseHtmlTable(text);
          const cards = table.map((cells, i) => {
            const term = cells[1] || cells[0] || '';
            const weight = cells[2] || '';
            return `<div class="group relative bg-gradient-to-br from-indigo-500 to-violet-600 rounded-xl p-4 shadow-md hover:shadow-xl transition-all duration-300 hover:scale-105 cursor-pointer" 
                    onclick="copyToClipboard('${S(term).replace(/'/g, "\\'")}', this)" 
                    title="點擊複製：${S(term)}">
              <div class="text-white font-semibold text-center text-lg mb-2 break-words">${S(term)}</div>
              ${weight ? `<div class="text-white/90 text-xs text-center">${S(weight)}</div>` : ''}
              <div class="absolute inset-0 bg-white/0 group-hover:bg-white/10 rounded-xl transition-all duration-300"></div>
            </div>`;
          });
          $('rows-assoc').innerHTML = cards.join('');
          setStatus('status-assoc', `完成（HTML 解析，共 ${table.length} 個關聯詞彙）`);
        }
      } catch(err){
        setStatus('status-assoc', (err?.message || err) + '（可能是 CORS、網路或伺服器問題）', true);
      } finally {
        $('btn-assoc').disabled = false;
        setGlobalStatus('就緒');
      }
    }

    // ======== /query/<q_string>/studies ========
    function buildQueryUrl(){
      const base = $("apiBase").value.replace(/\/$/, '');
      const q = $("queryStr").value.trim();
      return base + '/query/' + encodeURIComponent(q) + '/studies';
    }

    async function onQuery(e){
      e?.preventDefault();
      const q = $('queryStr').value.trim();
      if (!q) { setStatus('status-query', '請輸入 q_string', true); return; }
      const url = buildQueryUrl();
      setStatus('status-query', '請求中… ' + url);
      setGlobalStatus('/query/<q_string>/studies 請求中');
      $('btn-query').disabled = true;
      try{
        const resp = await api(url);
        const ct = resp.headers.get('content-type') || '';
        if (!resp.ok) { setStatus('status-query', `HTTP ${resp.status} ${resp.statusText}`, true); return; }
        if (ct.includes('application/json')){
          const data = await resp.json();
          const arr = guessArray(data);
          const cards = arr.map((x,i)=>{
            // x 是物件：{ id, study_id, title, authors, journal, year, contrast_id }
            const studyId = x.study_id || x.id || '';
            const title = x.title || '';
            const authors = x.authors || '';
            const journal = x.journal || '';
            const year = x.year || '';
            const contrastId = x.contrast_id || '';
            
            return `<div class="bg-slate-50 rounded-xl p-5 shadow hover:shadow-lg transition-all duration-300 border border-slate-200 hover:border-indigo-300">
              <div class="flex items-start justify-between gap-3 mb-3">
                <h3 class="text-lg font-semibold text-slate-800 flex-1">${S(title)}</h3>
                <span class="text-sm font-mono bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full whitespace-nowrap">${S(year)}</span>
              </div>
              <div class="space-y-2 text-sm text-slate-600">
                <div class="flex gap-2">
                  <span class="font-semibold text-slate-700">作者：</span>
                  <span class="flex-1">${S(authors)}</span>
                </div>
                <div class="flex gap-2">
                  <span class="font-semibold text-slate-700">期刊：</span>
                  <span class="flex-1 italic">${S(journal)}</span>
                </div>
                <div class="flex gap-2 items-center">
                  <span class="font-semibold text-slate-700">Study ID：</span>
                  <span class="font-mono text-indigo-600">${S(studyId)}</span>
                  ${contrastId ? `<span class="text-slate-400">/ Contrast: ${S(contrastId)}</span>` : ''}
                </div>
              </div>
            </div>`;
          });
          $('rows-query').innerHTML = cards.join('');
          
          // 顯示總數和應用的過濾器資訊
          const count = data.count || arr.length;
          const applied = data.applied || {};
          const appliedInfo = Object.entries(applied)
            .filter(([k,v]) => v === true)
            .map(([k]) => k)
            .join(', ') || '無';
          setStatus('status-query', `完成（共 ${count} 筆結果，顯示 ${arr.length} 筆，已套用過濾：${appliedInfo}）`);
        } else {
          const text = await resp.text();
          const table = parseHtmlTable(text);
          const cards = table.map((cells, i) => {
            const studyId = cells[1] || '';
            const title = cells[2] || '';
            const score = cells[3] || '';
            return `<div class="bg-slate-50 rounded-xl p-5 shadow hover:shadow-lg transition-all duration-300 border border-slate-200 hover:border-indigo-300">
              <div class="flex items-start justify-between gap-3 mb-3">
                <h3 class="text-lg font-semibold text-slate-800 flex-1">${S(title)}</h3>
                ${score ? `<span class="text-sm font-mono bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full">${S(score)}</span>` : ''}
              </div>
              <div class="text-sm text-slate-600">
                <span class="font-semibold text-slate-700">Study ID：</span>
                <span class="font-mono text-indigo-600">${S(studyId)}</span>
              </div>
            </div>`;
          });
          $('rows-query').innerHTML = cards.join('');
          setStatus('status-query', `完成（HTML 解析，共 ${table.length} 筆結果）`);
        }
      } catch(err){
        setStatus('status-query', (err?.message || err) + '（可能是 CORS、網路或伺服器問題）', true);
      } finally {
        $('btn-query').disabled = false;
        setGlobalStatus('就緒');
      }
    }

    // ======== Tab 切換 ========
    function activateTab(name){
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      const target = document.getElementById('tab-' + name);
      if (target) target.classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('ring', 'ring-white'));
      document.querySelector(`[data-tab="${name}"]`)?.classList.add('ring','ring-white');
      location.hash = name;
    }

    function initTabs(){
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => activateTab(btn.dataset.tab));
      });
      const hash = location.hash.replace('#','');
      if (['terms','assoc','query'].includes(hash)) activateTab(hash);
    }

    // ======== 綁定事件 ========
    document.getElementById('btn-terms').addEventListener('click', onTerms);
    document.getElementById('form-assoc').addEventListener('submit', onAssoc);
    document.getElementById('form-query').addEventListener('submit', onQuery);

    // ======== 預載容易理解的例子 ========
    window.addEventListener('DOMContentLoaded', () => {
      initTabs();
      // 示例參數
      $('assocT1').value = 'posterior_cingulate';
      $('queryStr').value = 'posterior_cingulate AND NOT ventromedial_prefrontal';
      // 預先查詢 /terms，讓使用者一進來就看到所有可用詞彙
      onTerms();
    });
  </script>
</body>
</html>
