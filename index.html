<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MIL Terms Explorer (Tailwind + AJAX)</title>
  <!-- Tailwind CDN：免安裝即可使用 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 純裝飾：滑動切換過場 */
    .tab { display: none; }
    .tab.active { display: block; animation: fade .2s ease; }
    @keyframes fade { from{opacity:0} to{opacity:1} }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="container mx-auto max-w-6xl p-4 md:p-8 space-y-6">
    <!-- Header -->
    <header class="rounded-2xl p-6 md:p-8 text-white shadow bg-gradient-to-r from-indigo-500 to-violet-600">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold">🧠 MIL Terms Explorer</h1>
          <p class="text-white/90">公開前端，用 AJAX 方式呼叫 API：<code>/terms</code>、<code>/terms/&lt;t1&gt;</code>、<code>/query/&lt;q_string&gt;/studies</code></p>
        </div>
        <div class="bg-white/15 rounded-xl px-3 py-2 text-sm flex items-center gap-2">
          <span>API Base URL：</span>
          <input id="apiBase" class="bg-white/20 rounded-lg px-2 py-1 w-[320px] focus:outline-none" value="https://mil.psy.ntu.edu.tw:5000" />
        </div>
      </div>
      <div class="mt-4 flex flex-wrap gap-2">
        <button data-tab="terms" class="tab-btn rounded-xl bg-white/20 px-3 py-1 text-sm font-semibold hover:bg-white/30">/terms</button>
        <button data-tab="assoc" class="tab-btn rounded-xl bg-white/20 px-3 py-1 text-sm font-semibold hover:bg-white/30">/terms/&lt;t1&gt;</button>
        <button data-tab="query" class="tab-btn rounded-xl bg-white/20 px-3 py-1 text-sm font-semibold hover:bg-white/30">/query/&lt;q_string&gt;/studies</button>
        <span id="globalStatus" class="ml-auto text-sm text-white/80">狀態：就緒</span>
      </div>
    </header>

    <!-- /terms 所有詞彙 -->
    <section id="tab-terms" class="tab active">
      <div class="bg-white rounded-xl shadow p-5 space-y-3">
        <h2 class="text-xl font-semibold">/terms：所有可用詞彙</h2>
        <form id="form-terms" class="grid grid-cols-1 sm:grid-cols-6 gap-3 items-end">
          <div class="sm:col-span-3">
            <label class="block text-sm text-slate-600 mb-1">（可選）過濾前綴 prefix</label>
            <input id="termsPrefix" placeholder="例如：post、hippo（留空=不過濾）" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">（可選）limit</label>
            <input id="termsLimit" type="number" min="1" placeholder="如 100" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">（可選）offset</label>
            <input id="termsOffset" type="number" min="0" placeholder="如 0" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <button id="btn-terms" class="sm:col-span-1 inline-flex items-center justify-center rounded-xl bg-indigo-600 px-4 py-2 font-semibold text-white shadow hover:bg-indigo-500 active:bg-indigo-700 transition disabled:opacity-60">查詢</button>
        </form>
        <p id="status-terms" class="text-sm text-slate-500">狀態：尚未查詢</p>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-indigo-600 text-white">
              <tr>
                <th class="px-3 py-2 text-left">#</th>
                <th class="px-3 py-2 text-left">Term</th>
                <th class="px-3 py-2 text-right">Weight / Count</th>
              </tr>
            </thead>
            <tbody id="rows-terms" class="[&>tr:nth-child(odd)]:bg-slate-50"></tbody>
          </table>
        </div>
        <div class="text-sm text-slate-500">提示：若後端回傳 HTML（表格），本頁也會自動解析。</div>
      </div>
    </section>

    <!-- /terms/<t1> 關聯詞彙 -->
    <section id="tab-assoc" class="tab">
      <div class="bg-white rounded-xl shadow p-5 space-y-3">
        <h2 class="text-xl font-semibold">/terms/&lt;t1&gt;：查詢與 t1 關聯的詞彙</h2>
        <form id="form-assoc" class="grid grid-cols-1 sm:grid-cols-5 gap-3 items-end">
          <div class="sm:col-span-3">
            <label class="block text-sm text-slate-600 mb-1">Term t1（必填）</label>
            <input id="assocT1" required placeholder="例如：posterior_cingulate" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">（可選）limit</label>
            <input id="assocLimit" type="number" min="1" placeholder="如 100" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <button id="btn-assoc" class="sm:col-span-1 inline-flex items-center justify-center rounded-xl bg-indigo-600 px-4 py-2 font-semibold text-white shadow hover:bg-indigo-500 active:bg-indigo-700 transition disabled:opacity-60">查詢</button>
        </form>
        <p class="text-slate-600">顯示：與 <span id="show-assocT1" class="font-semibold">（未填）</span> 的相關詞彙</p>
        <p id="status-assoc" class="text-sm text-slate-500">狀態：尚未查詢</p>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-indigo-600 text-white">
              <tr>
                <th class="px-3 py-2 text-left">#</th>
                <th class="px-3 py-2 text-left">Related Term</th>
                <th class="px-3 py-2 text-right">Weight / Score</th>
              </tr>
            </thead>
            <tbody id="rows-assoc" class="[&>tr:nth-child(odd)]:bg-slate-50"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- /query/<q_string>/studies 邏輯搜尋 -->
    <section id="tab-query" class="tab">
      <div class="bg-white rounded-xl shadow p-5 space-y-3">
        <h2 class="text-xl font-semibold">/query/&lt;q_string&gt;/studies：邏輯搜尋</h2>
        <form id="form-query" class="grid grid-cols-1 sm:grid-cols-5 gap-3 items-end">
          <div class="sm:col-span-3">
            <label class="block text-sm text-slate-600 mb-1">q_string（必填）</label>
            <input id="queryStr" required placeholder="例如：posterior_cingulate AND NOT ventromedial_prefrontal" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">（可選）limit</label>
            <input id="queryLimit" type="number" min="1" placeholder="如 100" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <button id="btn-query" class="sm:col-span-1 inline-flex items-center justify-center rounded-xl bg-indigo-600 px-4 py-2 font-semibold text-white shadow hover:bg-indigo-500 active:bg-indigo-700 transition disabled:opacity-60">查詢</button>
        </form>
        <p class="text-slate-600">查詢語句將自動 URL encode，例：空白、AND/OR/NOT 皆會被正確編碼。</p>
        <p id="status-query" class="text-sm text-slate-500">狀態：尚未查詢</p>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-indigo-600 text-white">
              <tr>
                <th class="px-3 py-2 text-left">#</th>
                <th class="px-3 py-2 text-left">Study ID</th>
                <th class="px-3 py-2 text-left">Title / Summary</th>
                <th class="px-3 py-2 text-right">Score</th>
              </tr>
            </thead>
            <tbody id="rows-query" class="[&>tr:nth-child(odd)]:bg-slate-50"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ======== 小工具 ========
    const $ = (id) => document.getElementById(id);

    function setGlobalStatus(msg) { $("globalStatus").textContent = "狀態：" + msg; }
    function setStatus(id, msg, isErr=false){
      const el = $(id);
      el.textContent = (isErr? "錯誤：" : "狀態：") + msg;
      el.className = 'text-sm ' + (isErr? 'text-red-600' : 'text-slate-500');
    }

    function api(url) {
      // 接受 JSON 或 HTML 兩種情況
      return fetch(url, { headers: { 'Accept': 'application/json,text/html;q=0.9,*/*;q=0.8' } });
    }

    // 嘗試從 JSON 結構抽出陣列
    function guessArray(data){
      if (Array.isArray(data)) return data;
      if (data == null) return [];
      if (Array.isArray(data.items)) return data.items;
      if (Array.isArray(data.results)) return data.results;
      if (Array.isArray(data.data)) return data.data;
      // 若是物件 map：{ term: count, ... }
      if (typeof data === 'object') {
        const entries = Object.entries(data);
        if (entries.every(([k,v]) => typeof v === 'number' || typeof v === 'string' || typeof v === 'object')) {
          return entries.map(([k,v]) => ({ term: k, value: v }));
        }
      }
      return [];
    }

    // 將任何值安全轉成字串
    const S = (x) => (x == null ? '' : String(x));

    // 解析 HTML 表格為列資料（通用備援）
    function parseHtmlTable(html){
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const trs = Array.from(doc.querySelectorAll('tbody tr'));
      return trs.map(tr => Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim()));
    }

    // 渲染通用表格列
    function renderRows(tbodyId, rowsHtml){ $(tbodyId).innerHTML = rowsHtml.join(''); }

    // ======== /terms ========
    function buildTermsUrl(){
      const base = $("apiBase").value.replace(/\/$/, '');
      const u = new URL(base + '/terms');
      const prefix = $("termsPrefix").value.trim();
      const limit = $("termsLimit").value.trim();
      const offset = $("termsOffset").value.trim();
      if (prefix) u.searchParams.set('prefix', prefix);
      if (limit) u.searchParams.set('limit', limit);
      if (offset) u.searchParams.set('offset', offset);
      return u.toString();
    }

    async function onTerms(e){
      e?.preventDefault();
      const url = buildTermsUrl();
      setStatus('status-terms', '請求中… ' + url);
      setGlobalStatus('/terms 請求中');
      $('btn-terms').disabled = true;
      try {
        const resp = await api(url);
        const ct = resp.headers.get('content-type') || '';
        if (!resp.ok) { setStatus('status-terms', `HTTP ${resp.status} ${resp.statusText}`, true); return; }
        if (ct.includes('application/json')){
          const data = await resp.json();
          const arr = guessArray(data);
          const rows = arr.map((x,i)=>{
            // x 可能是字串或物件
            const term = x.term || x.name || (typeof x === 'string' ? x : (x[0] || ''));
            const weight = x.weight || x.score || x.count || x.value || '';
            return `<tr class="hover:bg-slate-100 transition"><td class="px-3 py-2">${i+1}</td><td class="px-3 py-2">${S(term)}</td><td class="px-3 py-2 text-right">${S(weight)}</td></tr>`;
          });
          renderRows('rows-terms', rows);
          setStatus('status-terms', '完成（JSON）');
        } else {
          const text = await resp.text();
          const table = parseHtmlTable(text); // [[#, term, weight], ...]
          const rows = table.map(cells => `<tr class="hover:bg-slate-100 transition">`
            + `<td class="px-3 py-2">${S(cells[0])}</td>`
            + `<td class="px-3 py-2">${S(cells[1])}</td>`
            + `<td class="px-3 py-2 text-right">${S(cells[2])}</td>`
            + `</tr>`);
          renderRows('rows-terms', rows);
          setStatus('status-terms', '完成（HTML 解析）');
        }
      } catch (err) {
        setStatus('status-terms', (err?.message || err) + '（可能是 CORS、網路或伺服器問題）', true);
      } finally {
        $('btn-terms').disabled = false;
        setGlobalStatus('就緒');
      }
    }

    // ======== /terms/<t1> ========
    function buildAssocUrl(){
      const base = $("apiBase").value.replace(/\/$/, '');
      const t1 = $("assocT1").value.trim();
      const u = new URL(base + '/terms/' + encodeURIComponent(t1));
      const limit = $("assocLimit").value.trim();
      if (limit) u.searchParams.set('limit', limit);
      return u.toString();
    }

    async function onAssoc(e){
      e?.preventDefault();
      const t1 = $('assocT1').value.trim();
      $("show-assocT1").textContent = t1 || '（未填）';
      if (!t1) { setStatus('status-assoc', '請輸入 t1', true); return; }
      const url = buildAssocUrl();
      setStatus('status-assoc', '請求中… ' + url);
      setGlobalStatus('/terms/<t1> 請求中');
      $('btn-assoc').disabled = true;
      try{
        const resp = await api(url);
        const ct = resp.headers.get('content-type') || '';
        if (!resp.ok) { setStatus('status-assoc', `HTTP ${resp.status} ${resp.statusText}`, true); return; }
        if (ct.includes('application/json')){
          const data = await resp.json();
          const arr = guessArray(data);
          const rows = arr.map((x,i)=>{
            const term = x.term || x.name || x.related || (typeof x === 'string' ? x : (x[0] || ''));
            const weight = x.weight || x.score || x.count || x.value || '';
            return `<tr class="hover:bg-slate-100 transition"><td class="px-3 py-2">${i+1}</td><td class="px-3 py-2">${S(term)}</td><td class="px-3 py-2 text-right">${S(weight)}</td></tr>`;
          });
          renderRows('rows-assoc', rows);
          setStatus('status-assoc', '完成（JSON）');
        } else {
          const text = await resp.text();
          const table = parseHtmlTable(text); // [[#, related_term, weight], ...]
          const rows = table.map(cells => `<tr class="hover:bg-slate-100 transition">`
            + `<td class="px-3 py-2">${S(cells[0])}</td>`
            + `<td class="px-3 py-2">${S(cells[1])}</td>`
            + `<td class="px-3 py-2 text-right">${S(cells[2])}</td>`
            + `</tr>`);
          renderRows('rows-assoc', rows);
          setStatus('status-assoc', '完成（HTML 解析）');
        }
      } catch(err){
        setStatus('status-assoc', (err?.message || err) + '（可能是 CORS、網路或伺服器問題）', true);
      } finally {
        $('btn-assoc').disabled = false;
        setGlobalStatus('就緒');
      }
    }

    // ======== /query/<q_string>/studies ========
    function buildQueryUrl(){
      const base = $("apiBase").value.replace(/\/$/, '');
      const q = $("queryStr").value.trim();
      const u = new URL(base + '/query/' + encodeURIComponent(q) + '/studies');
      const limit = $("queryLimit").value.trim();
      if (limit) u.searchParams.set('limit', limit);
      return u.toString();
    }

    async function onQuery(e){
      e?.preventDefault();
      const q = $('queryStr').value.trim();
      if (!q) { setStatus('status-query', '請輸入 q_string', true); return; }
      const url = buildQueryUrl();
      setStatus('status-query', '請求中… ' + url);
      setGlobalStatus('/query/<q_string>/studies 請求中');
      $('btn-query').disabled = true;
      try{
        const resp = await api(url);
        const ct = resp.headers.get('content-type') || '';
        if (!resp.ok) { setStatus('status-query', `HTTP ${resp.status} ${resp.statusText}`, true); return; }
        if (ct.includes('application/json')){
          const data = await resp.json();
          const arr = guessArray(data);
          const rows = arr.map((x,i)=>{
            const id = x.study_id || x.id || x.pmid || x.study || '';
            const title = x.title || x.summary || x.abstract || '';
            const score = x.score || x.weight || x.value || '';
            return `<tr class="hover:bg-slate-100 transition">`
              + `<td class="px-3 py-2">${i+1}</td>`
              + `<td class="px-3 py-2">${S(id)}</td>`
              + `<td class="px-3 py-2">${S(title)}</td>`
              + `<td class="px-3 py-2 text-right">${S(score)}</td>`
              + `</tr>`;
          });
          renderRows('rows-query', rows);
          setStatus('status-query', '完成（JSON）');
        } else {
          const text = await resp.text();
          const table = parseHtmlTable(text); // [[#, id, title, score], ...]（依對方表格為準）
          const rows = table.map(cells => `<tr class="hover:bg-slate-100 transition">`
            + `<td class="px-3 py-2">${S(cells[0])}</td>`
            + `<td class="px-3 py-2">${S(cells[1])}</td>`
            + `<td class="px-3 py-2">${S(cells[2])}</td>`
            + `<td class="px-3 py-2 text-right">${S(cells[3])}</td>`
            + `</tr>`);
          renderRows('rows-query', rows);
          setStatus('status-query', '完成（HTML 解析）');
        }
      } catch(err){
        setStatus('status-query', (err?.message || err) + '（可能是 CORS、網路或伺服器問題）', true);
      } finally {
        $('btn-query').disabled = false;
        setGlobalStatus('就緒');
      }
    }

    // ======== Tab 切換 ========
    function activateTab(name){
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      const target = document.getElementById('tab-' + name);
      if (target) target.classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('ring', 'ring-white'));
      document.querySelector(`[data-tab="${name}"]`)?.classList.add('ring','ring-white');
      location.hash = name;
    }

    function initTabs(){
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => activateTab(btn.dataset.tab));
      });
      const hash = location.hash.replace('#','');
      if (['terms','assoc','query'].includes(hash)) activateTab(hash);
    }

    // ======== 綁定事件 ========
    document.getElementById('form-terms').addEventListener('submit', onTerms);
    document.getElementById('form-assoc').addEventListener('submit', onAssoc);
    document.getElementById('form-query').addEventListener('submit', onQuery);

    // ======== 預載容易理解的例子 ========
    window.addEventListener('DOMContentLoaded', () => {
      initTabs();
      // 示例參數
      $('termsPrefix').value = '';
      $('assocT1').value = 'posterior_cingulate';
      $('queryStr').value = 'posterior_cingulate AND NOT ventromedial_prefrontal';
      // 預先查一次 /terms/<t1>，方便示範
      onAssoc(new Event('submit'));
    });
  </script>
</body>
</html>