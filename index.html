<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MIL Terms Explorer (Tailwind + AJAX)</title>
  <!-- Tailwind CDNï¼šå…å®‰è£å³å¯ä½¿ç”¨ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ç´”è£é£¾ï¼šæ»‘å‹•åˆ‡æ›éå ´ */
    .tab { display: none; }
    .tab.active { display: block; animation: fade .2s ease; }
    @keyframes fade { from{opacity:0} to{opacity:1} }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="container mx-auto max-w-6xl p-4 md:p-8 space-y-6">
    <!-- Header -->
    <header class="rounded-2xl p-6 md:p-8 text-white shadow bg-gradient-to-r from-indigo-500 to-violet-600">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold">ğŸ§  MIL Terms Explorer</h1>
          <p class="text-white/90">å…¬é–‹å‰ç«¯ï¼Œç”¨ AJAX æ–¹å¼å‘¼å« APIï¼š<code>/terms</code>ã€<code>/terms/&lt;t1&gt;</code>ã€<code>/query/&lt;q_string&gt;/studies</code></p>
        </div>
        <div class="bg-white/15 rounded-xl px-3 py-2 text-sm flex items-center gap-2">
          <span>API Base URLï¼š</span>
          <input id="apiBase" class="bg-white/20 rounded-lg px-2 py-1 w-[320px] focus:outline-none" value="https://mil.psy.ntu.edu.tw:5000" />
        </div>
      </div>
      <div class="mt-4 flex flex-wrap gap-2">
        <button data-tab="terms" class="tab-btn rounded-xl bg-white/20 px-3 py-1 text-sm font-semibold hover:bg-white/30">/terms</button>
        <button data-tab="assoc" class="tab-btn rounded-xl bg-white/20 px-3 py-1 text-sm font-semibold hover:bg-white/30">/terms/&lt;t1&gt;</button>
        <button data-tab="query" class="tab-btn rounded-xl bg-white/20 px-3 py-1 text-sm font-semibold hover:bg-white/30">/query/&lt;q_string&gt;/studies</button>
        <span id="globalStatus" class="ml-auto text-sm text-white/80">ç‹€æ…‹ï¼šå°±ç·’</span>
      </div>
    </header>

    <!-- /terms æ‰€æœ‰è©å½™ -->
    <section id="tab-terms" class="tab active">
      <div class="bg-white rounded-xl shadow p-5 space-y-3">
        <h2 class="text-xl font-semibold">/termsï¼šæ‰€æœ‰å¯ç”¨è©å½™</h2>
        <form id="form-terms" class="grid grid-cols-1 sm:grid-cols-6 gap-3 items-end">
          <div class="sm:col-span-3">
            <label class="block text-sm text-slate-600 mb-1">ï¼ˆå¯é¸ï¼‰éæ¿¾å‰ç¶´ prefix</label>
            <input id="termsPrefix" placeholder="ä¾‹å¦‚ï¼špostã€hippoï¼ˆç•™ç©º=ä¸éæ¿¾ï¼‰" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">ï¼ˆå¯é¸ï¼‰limit</label>
            <input id="termsLimit" type="number" min="1" placeholder="å¦‚ 100" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">ï¼ˆå¯é¸ï¼‰offset</label>
            <input id="termsOffset" type="number" min="0" placeholder="å¦‚ 0" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <button id="btn-terms" class="sm:col-span-1 inline-flex items-center justify-center rounded-xl bg-indigo-600 px-4 py-2 font-semibold text-white shadow hover:bg-indigo-500 active:bg-indigo-700 transition disabled:opacity-60">æŸ¥è©¢</button>
        </form>
        <p id="status-terms" class="text-sm text-slate-500">ç‹€æ…‹ï¼šå°šæœªæŸ¥è©¢</p>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-indigo-600 text-white">
              <tr>
                <th class="px-3 py-2 text-left">#</th>
                <th class="px-3 py-2 text-left">Term</th>
                <th class="px-3 py-2 text-right">Weight / Count</th>
              </tr>
            </thead>
            <tbody id="rows-terms" class="[&>tr:nth-child(odd)]:bg-slate-50"></tbody>
          </table>
        </div>
        <div class="text-sm text-slate-500">æç¤ºï¼šè‹¥å¾Œç«¯å›å‚³ HTMLï¼ˆè¡¨æ ¼ï¼‰ï¼Œæœ¬é ä¹Ÿæœƒè‡ªå‹•è§£æã€‚</div>
      </div>
    </section>

    <!-- /terms/<t1> é—œè¯è©å½™ -->
    <section id="tab-assoc" class="tab">
      <div class="bg-white rounded-xl shadow p-5 space-y-3">
        <h2 class="text-xl font-semibold">/terms/&lt;t1&gt;ï¼šæŸ¥è©¢èˆ‡ t1 é—œè¯çš„è©å½™</h2>
        <form id="form-assoc" class="grid grid-cols-1 sm:grid-cols-5 gap-3 items-end">
          <div class="sm:col-span-3">
            <label class="block text-sm text-slate-600 mb-1">Term t1ï¼ˆå¿…å¡«ï¼‰</label>
            <input id="assocT1" required placeholder="ä¾‹å¦‚ï¼šposterior_cingulate" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">ï¼ˆå¯é¸ï¼‰limit</label>
            <input id="assocLimit" type="number" min="1" placeholder="å¦‚ 100" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <button id="btn-assoc" class="sm:col-span-1 inline-flex items-center justify-center rounded-xl bg-indigo-600 px-4 py-2 font-semibold text-white shadow hover:bg-indigo-500 active:bg-indigo-700 transition disabled:opacity-60">æŸ¥è©¢</button>
        </form>
        <p class="text-slate-600">é¡¯ç¤ºï¼šèˆ‡ <span id="show-assocT1" class="font-semibold">ï¼ˆæœªå¡«ï¼‰</span> çš„ç›¸é—œè©å½™</p>
        <p id="status-assoc" class="text-sm text-slate-500">ç‹€æ…‹ï¼šå°šæœªæŸ¥è©¢</p>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-indigo-600 text-white">
              <tr>
                <th class="px-3 py-2 text-left">#</th>
                <th class="px-3 py-2 text-left">Related Term</th>
                <th class="px-3 py-2 text-right">Weight / Score</th>
              </tr>
            </thead>
            <tbody id="rows-assoc" class="[&>tr:nth-child(odd)]:bg-slate-50"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- /query/<q_string>/studies é‚è¼¯æœå°‹ -->
    <section id="tab-query" class="tab">
      <div class="bg-white rounded-xl shadow p-5 space-y-3">
        <h2 class="text-xl font-semibold">/query/&lt;q_string&gt;/studiesï¼šé‚è¼¯æœå°‹</h2>
        <form id="form-query" class="grid grid-cols-1 sm:grid-cols-5 gap-3 items-end">
          <div class="sm:col-span-3">
            <label class="block text-sm text-slate-600 mb-1">q_stringï¼ˆå¿…å¡«ï¼‰</label>
            <input id="queryStr" required placeholder="ä¾‹å¦‚ï¼šposterior_cingulate AND NOT ventromedial_prefrontal" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">ï¼ˆå¯é¸ï¼‰limit</label>
            <input id="queryLimit" type="number" min="1" placeholder="å¦‚ 100" class="w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60" />
          </div>
          <button id="btn-query" class="sm:col-span-1 inline-flex items-center justify-center rounded-xl bg-indigo-600 px-4 py-2 font-semibold text-white shadow hover:bg-indigo-500 active:bg-indigo-700 transition disabled:opacity-60">æŸ¥è©¢</button>
        </form>
        <p class="text-slate-600">æŸ¥è©¢èªå¥å°‡è‡ªå‹• URL encodeï¼Œä¾‹ï¼šç©ºç™½ã€AND/OR/NOT çš†æœƒè¢«æ­£ç¢ºç·¨ç¢¼ã€‚</p>
        <p id="status-query" class="text-sm text-slate-500">ç‹€æ…‹ï¼šå°šæœªæŸ¥è©¢</p>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-indigo-600 text-white">
              <tr>
                <th class="px-3 py-2 text-left">#</th>
                <th class="px-3 py-2 text-left">Study ID</th>
                <th class="px-3 py-2 text-left">Title / Summary</th>
                <th class="px-3 py-2 text-right">Score</th>
              </tr>
            </thead>
            <tbody id="rows-query" class="[&>tr:nth-child(odd)]:bg-slate-50"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ======== å°å·¥å…· ========
    const $ = (id) => document.getElementById(id);

    function setGlobalStatus(msg) { $("globalStatus").textContent = "ç‹€æ…‹ï¼š" + msg; }
    function setStatus(id, msg, isErr=false){
      const el = $(id);
      el.textContent = (isErr? "éŒ¯èª¤ï¼š" : "ç‹€æ…‹ï¼š") + msg;
      el.className = 'text-sm ' + (isErr? 'text-red-600' : 'text-slate-500');
    }

    function api(url) {
      // æ¥å— JSON æˆ– HTML å…©ç¨®æƒ…æ³
      return fetch(url, { headers: { 'Accept': 'application/json,text/html;q=0.9,*/*;q=0.8' } });
    }

    // å˜—è©¦å¾ JSON çµæ§‹æŠ½å‡ºé™£åˆ—
    function guessArray(data){
      if (Array.isArray(data)) return data;
      if (data == null) return [];
      if (Array.isArray(data.items)) return data.items;
      if (Array.isArray(data.results)) return data.results;
      if (Array.isArray(data.data)) return data.data;
      // è‹¥æ˜¯ç‰©ä»¶ mapï¼š{ term: count, ... }
      if (typeof data === 'object') {
        const entries = Object.entries(data);
        if (entries.every(([k,v]) => typeof v === 'number' || typeof v === 'string' || typeof v === 'object')) {
          return entries.map(([k,v]) => ({ term: k, value: v }));
        }
      }
      return [];
    }

    // å°‡ä»»ä½•å€¼å®‰å…¨è½‰æˆå­—ä¸²
    const S = (x) => (x == null ? '' : String(x));

    // è§£æ HTML è¡¨æ ¼ç‚ºåˆ—è³‡æ–™ï¼ˆé€šç”¨å‚™æ´ï¼‰
    function parseHtmlTable(html){
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const trs = Array.from(doc.querySelectorAll('tbody tr'));
      return trs.map(tr => Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim()));
    }

    // æ¸²æŸ“é€šç”¨è¡¨æ ¼åˆ—
    function renderRows(tbodyId, rowsHtml){ $(tbodyId).innerHTML = rowsHtml.join(''); }

    // ======== /terms ========
    function buildTermsUrl(){
      const base = $("apiBase").value.replace(/\/$/, '');
      const u = new URL(base + '/terms');
      const prefix = $("termsPrefix").value.trim();
      const limit = $("termsLimit").value.trim();
      const offset = $("termsOffset").value.trim();
      if (prefix) u.searchParams.set('prefix', prefix);
      if (limit) u.searchParams.set('limit', limit);
      if (offset) u.searchParams.set('offset', offset);
      return u.toString();
    }

    async function onTerms(e){
      e?.preventDefault();
      const url = buildTermsUrl();
      setStatus('status-terms', 'è«‹æ±‚ä¸­â€¦ ' + url);
      setGlobalStatus('/terms è«‹æ±‚ä¸­');
      $('btn-terms').disabled = true;
      try {
        const resp = await api(url);
        const ct = resp.headers.get('content-type') || '';
        if (!resp.ok) { setStatus('status-terms', `HTTP ${resp.status} ${resp.statusText}`, true); return; }
        if (ct.includes('application/json')){
          const data = await resp.json();
          const arr = guessArray(data);
          const rows = arr.map((x,i)=>{
            // x å¯èƒ½æ˜¯å­—ä¸²æˆ–ç‰©ä»¶
            const term = x.term || x.name || (typeof x === 'string' ? x : (x[0] || ''));
            const weight = x.weight || x.score || x.count || x.value || '';
            return `<tr class="hover:bg-slate-100 transition"><td class="px-3 py-2">${i+1}</td><td class="px-3 py-2">${S(term)}</td><td class="px-3 py-2 text-right">${S(weight)}</td></tr>`;
          });
          renderRows('rows-terms', rows);
          setStatus('status-terms', 'å®Œæˆï¼ˆJSONï¼‰');
        } else {
          const text = await resp.text();
          const table = parseHtmlTable(text); // [[#, term, weight], ...]
          const rows = table.map(cells => `<tr class="hover:bg-slate-100 transition">`
            + `<td class="px-3 py-2">${S(cells[0])}</td>`
            + `<td class="px-3 py-2">${S(cells[1])}</td>`
            + `<td class="px-3 py-2 text-right">${S(cells[2])}</td>`
            + `</tr>`);
          renderRows('rows-terms', rows);
          setStatus('status-terms', 'å®Œæˆï¼ˆHTML è§£æï¼‰');
        }
      } catch (err) {
        setStatus('status-terms', (err?.message || err) + 'ï¼ˆå¯èƒ½æ˜¯ CORSã€ç¶²è·¯æˆ–ä¼ºæœå™¨å•é¡Œï¼‰', true);
      } finally {
        $('btn-terms').disabled = false;
        setGlobalStatus('å°±ç·’');
      }
    }

    // ======== /terms/<t1> ========
    function buildAssocUrl(){
      const base = $("apiBase").value.replace(/\/$/, '');
      const t1 = $("assocT1").value.trim();
      const u = new URL(base + '/terms/' + encodeURIComponent(t1));
      const limit = $("assocLimit").value.trim();
      if (limit) u.searchParams.set('limit', limit);
      return u.toString();
    }

    async function onAssoc(e){
      e?.preventDefault();
      const t1 = $('assocT1').value.trim();
      $("show-assocT1").textContent = t1 || 'ï¼ˆæœªå¡«ï¼‰';
      if (!t1) { setStatus('status-assoc', 'è«‹è¼¸å…¥ t1', true); return; }
      const url = buildAssocUrl();
      setStatus('status-assoc', 'è«‹æ±‚ä¸­â€¦ ' + url);
      setGlobalStatus('/terms/<t1> è«‹æ±‚ä¸­');
      $('btn-assoc').disabled = true;
      try{
        const resp = await api(url);
        const ct = resp.headers.get('content-type') || '';
        if (!resp.ok) { setStatus('status-assoc', `HTTP ${resp.status} ${resp.statusText}`, true); return; }
        if (ct.includes('application/json')){
          const data = await resp.json();
          const arr = guessArray(data);
          const rows = arr.map((x,i)=>{
            const term = x.term || x.name || x.related || (typeof x === 'string' ? x : (x[0] || ''));
            const weight = x.weight || x.score || x.count || x.value || '';
            return `<tr class="hover:bg-slate-100 transition"><td class="px-3 py-2">${i+1}</td><td class="px-3 py-2">${S(term)}</td><td class="px-3 py-2 text-right">${S(weight)}</td></tr>`;
          });
          renderRows('rows-assoc', rows);
          setStatus('status-assoc', 'å®Œæˆï¼ˆJSONï¼‰');
        } else {
          const text = await resp.text();
          const table = parseHtmlTable(text); // [[#, related_term, weight], ...]
          const rows = table.map(cells => `<tr class="hover:bg-slate-100 transition">`
            + `<td class="px-3 py-2">${S(cells[0])}</td>`
            + `<td class="px-3 py-2">${S(cells[1])}</td>`
            + `<td class="px-3 py-2 text-right">${S(cells[2])}</td>`
            + `</tr>`);
          renderRows('rows-assoc', rows);
          setStatus('status-assoc', 'å®Œæˆï¼ˆHTML è§£æï¼‰');
        }
      } catch(err){
        setStatus('status-assoc', (err?.message || err) + 'ï¼ˆå¯èƒ½æ˜¯ CORSã€ç¶²è·¯æˆ–ä¼ºæœå™¨å•é¡Œï¼‰', true);
      } finally {
        $('btn-assoc').disabled = false;
        setGlobalStatus('å°±ç·’');
      }
    }

    // ======== /query/<q_string>/studies ========
    function buildQueryUrl(){
      const base = $("apiBase").value.replace(/\/$/, '');
      const q = $("queryStr").value.trim();
      const u = new URL(base + '/query/' + encodeURIComponent(q) + '/studies');
      const limit = $("queryLimit").value.trim();
      if (limit) u.searchParams.set('limit', limit);
      return u.toString();
    }

    async function onQuery(e){
      e?.preventDefault();
      const q = $('queryStr').value.trim();
      if (!q) { setStatus('status-query', 'è«‹è¼¸å…¥ q_string', true); return; }
      const url = buildQueryUrl();
      setStatus('status-query', 'è«‹æ±‚ä¸­â€¦ ' + url);
      setGlobalStatus('/query/<q_string>/studies è«‹æ±‚ä¸­');
      $('btn-query').disabled = true;
      try{
        const resp = await api(url);
        const ct = resp.headers.get('content-type') || '';
        if (!resp.ok) { setStatus('status-query', `HTTP ${resp.status} ${resp.statusText}`, true); return; }
        if (ct.includes('application/json')){
          const data = await resp.json();
          const arr = guessArray(data);
          const rows = arr.map((x,i)=>{
            const id = x.study_id || x.id || x.pmid || x.study || '';
            const title = x.title || x.summary || x.abstract || '';
            const score = x.score || x.weight || x.value || '';
            return `<tr class="hover:bg-slate-100 transition">`
              + `<td class="px-3 py-2">${i+1}</td>`
              + `<td class="px-3 py-2">${S(id)}</td>`
              + `<td class="px-3 py-2">${S(title)}</td>`
              + `<td class="px-3 py-2 text-right">${S(score)}</td>`
              + `</tr>`;
          });
          renderRows('rows-query', rows);
          setStatus('status-query', 'å®Œæˆï¼ˆJSONï¼‰');
        } else {
          const text = await resp.text();
          const table = parseHtmlTable(text); // [[#, id, title, score], ...]ï¼ˆä¾å°æ–¹è¡¨æ ¼ç‚ºæº–ï¼‰
          const rows = table.map(cells => `<tr class="hover:bg-slate-100 transition">`
            + `<td class="px-3 py-2">${S(cells[0])}</td>`
            + `<td class="px-3 py-2">${S(cells[1])}</td>`
            + `<td class="px-3 py-2">${S(cells[2])}</td>`
            + `<td class="px-3 py-2 text-right">${S(cells[3])}</td>`
            + `</tr>`);
          renderRows('rows-query', rows);
          setStatus('status-query', 'å®Œæˆï¼ˆHTML è§£æï¼‰');
        }
      } catch(err){
        setStatus('status-query', (err?.message || err) + 'ï¼ˆå¯èƒ½æ˜¯ CORSã€ç¶²è·¯æˆ–ä¼ºæœå™¨å•é¡Œï¼‰', true);
      } finally {
        $('btn-query').disabled = false;
        setGlobalStatus('å°±ç·’');
      }
    }

    // ======== Tab åˆ‡æ› ========
    function activateTab(name){
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      const target = document.getElementById('tab-' + name);
      if (target) target.classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('ring', 'ring-white'));
      document.querySelector(`[data-tab="${name}"]`)?.classList.add('ring','ring-white');
      location.hash = name;
    }

    function initTabs(){
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => activateTab(btn.dataset.tab));
      });
      const hash = location.hash.replace('#','');
      if (['terms','assoc','query'].includes(hash)) activateTab(hash);
    }

    // ======== ç¶å®šäº‹ä»¶ ========
    document.getElementById('form-terms').addEventListener('submit', onTerms);
    document.getElementById('form-assoc').addEventListener('submit', onAssoc);
    document.getElementById('form-query').addEventListener('submit', onQuery);

    // ======== é è¼‰å®¹æ˜“ç†è§£çš„ä¾‹å­ ========
    window.addEventListener('DOMContentLoaded', () => {
      initTabs();
      // ç¤ºä¾‹åƒæ•¸
      $('termsPrefix').value = '';
      $('assocT1').value = 'posterior_cingulate';
      $('queryStr').value = 'posterior_cingulate AND NOT ventromedial_prefrontal';
      // é å…ˆæŸ¥ä¸€æ¬¡ /terms/<t1>ï¼Œæ–¹ä¾¿ç¤ºç¯„
      onAssoc(new Event('submit'));
    });
  </script>
</body>
</html>